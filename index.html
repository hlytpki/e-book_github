<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>花東執誌</title>
  <style>
    body {
      background: #ccc;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    #flipbook-container {
      width: 100%;
      height: calc(100% - 1rem);
      position: absolute;
      overflow: hidden;
      cursor: grab;
      z-index: 1;
    }

    #flipbook {
      width: 100%;
      height: 100%;
      position: absolute;
      z-index: 0;
    }

    #flipbook .page {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #flipbook img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 0.5rem;
      background-color: black;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
    }

    .controls button {
      margin-right: 0.5rem;
    }

    #extra-block {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1rem;
      background-color: black;
      z-index: 2;
      transition: bottom 0.3s ease;
    }

    #zoom-controls {
      position: fixed;
      top: 0.5rem;
      right: 0.5rem;
      z-index: 3;
    }

    #zoom-controls button {
      display: block;
      margin-bottom: 0.5rem;
    }
  </style>
</head>

<body>

  <div id="flipbook-container">
    <div id="flipbook">
      <!-- JavaScript will dynamically generate div elements here -->
    </div>
  </div>

  <!-- New block -->
  <div id="extra-block">
    <!-- Move the buttons here -->
    <div class="controls">
      <button id="prevPage">Previous Page</button>
      Page:
      <input type="text" id="pageFld" readonly />
      <button id="nextPage">Next Page</button>
      <button id="zoomIn">Zoom In</button>
      <button id="zoomOut">Zoom Out</button>
    </div>
  </div>

  <!-- Zoom controls -->
  <div id="zoom-controls" style="display: none;">
    <button id="zoomInMore">Zoom In More</button>
    <button id="zoomOutMore">Zoom Out More</button>
  </div>

  <script src='javascript/jquery-3.7.1.min.js'></script>
  <script src='javascript/turnjs4/lib/turn.min.js'></script>
  <script src='javascript/turnjs4/lib/zoom.min.js'></script>
  <script>
    var scale = 1;
    var isZoomed = false;
    var isSinglePageView = false;

    $(window).ready(function () {
      // Get images from GitHub API
      $.get('https://api.github.com/repos/hlytpki/ebook/contents/files/', function (data) {
        var pageCount = data.length;
        for (var i = 0; i < pageCount; i++) {
          $('#flipbook').append('<div class="page"><img src="' + data[i].download_url + '"></div>');
        }

        // Initialize flipbook
        $('#flipbook').turn({
          display: getDisplayMode(),
          acceleration: true,
          gradients: !$.isTouch,
          elevation: 50,
          autoCenter: true,
          when: {
            turned: function (e, page) {
              updatePageField(page, pageCount);
            }
          }
        });

        // Adjust flipbook size
        $(window).resize(function () {
          adjustFlipbookSize();
          var currentPage = $('#flipbook').turn('page');
          updatePageField(currentPage, pageCount);
        }).resize();
      });

      // Previous Page Button
      $('#prevPage').click(function () {
        if (!isZoomed) {
          $('#flipbook').turn('previous');
        }
      });

      // Next Page Button
      $('#nextPage').click(function () {
        if (!isZoomed) {
          $('#flipbook').turn('next');
        }
      });

      // Zoom In Button
      $('#zoomIn').click(function () {
        $('#flipbook').turn('zoom', 2);
        isZoomed = true;
        $('#zoom-controls').show();
      });

      // Zoom Out Button
      $('#zoomOut').click(function () {
        $('#flipbook').turn('zoom', 1);
        isZoomed = false;
        $('#zoom-controls').hide();
        $('#extra-block').show();
        resetZoom();
      });

      // Zoom In More Button
      $('#zoomInMore').click(function () {
        scale += 0.1;
        $('#flipbook').css('transform', 'scale(' + scale + ')');
      });

      // Zoom Out More Button
      $('#zoomOutMore').click(function () {
        scale = Math.max(1, scale - 0.1);
        $('#flipbook').css('transform', 'scale(' + scale + ')');
      });

      // Enable drag functionality
      $('#flipbook-container').on('mousedown', function (e) {
        if (isZoomed) {
          $(this).css('cursor', 'grabbing');
          var startX = e.clientX;
          var startY = e.clientY;
          var scrollLeft = $(this).scrollLeft();
          var scrollTop = $(this).scrollTop();

          $(this).on('mousemove', function (event) {
            var dx = event.clientX - startX;
            var dy = event.clientY - startY;
            $(this).scrollLeft(scrollLeft - dx);
            $(this).scrollTop(scrollTop - dy);
          });
        }
      });

      // Disable drag functionality
      $(document).on('mouseup', function () {
        $('#flipbook-container').css('cursor', 'grab');
        $('#flipbook-container').off('mousemove');
      });

    });

    function updatePageField(page, totalPages) {
      if (isSinglePageView) {
        $('#pageFld').val(page + ' / ' + totalPages);
      } else {
        if (page === 1) {
          $('#pageFld').val('1 / ' + totalPages);
        } else if (page % 2 === 0) {
          $('#pageFld').val(page + ' - ' + (page + 1) + ' / ' + totalPages);
        } else {
          $('#pageFld').val((page - 1) + ' - ' + page + ' / ' + totalPages);
        }
      }
    }

    function adjustFlipbookSize() {
      var flipbook = $('#flipbook');
      var windowWidth = $(window).width();
      var windowHeight = $(window).height();
      isSinglePageView = windowWidth < 560 || windowHeight < 560;
      if (isSinglePageView) {
        flipbook.turn('display', 'single');
        flipbook.turn("size", windowWidth, windowHeight);
      } else {
        flipbook.turn('display', 'double');
        flipbook.turn("size", windowWidth * 0.67, windowHeight * 0.93);
      }
    }

    function getDisplayMode() {
      var userAgent = navigator.userAgent.toLowerCase();
      if (userAgent.includes('mobi') || userAgent.includes('android') || userAgent.includes('iphone') || userAgent.includes('ipad')) {
        return 'single';
      } else {
        return 'double';
      }
    }

    function resetZoom() {
      scale = 1;
      $('#flipbook').css('transform', 'scale(' + scale + ')');
    }
  </script>
</body>
</html>
